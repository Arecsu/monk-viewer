var v=Object.defineProperty;var y=(n,i,e)=>i in n?v(n,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[i]=e;var a=(n,i,e)=>y(n,typeof i!="symbol"?i+"":i,e);import{i as w}from"./renderer-1.2.3.js";function b(){return new Worker(new URL("offscreencanvas-worker-1.2.3.js",import.meta.url).href,{type:"module"})}const A=/android/i.test(navigator.userAgent),k=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream||/Mac/.test(navigator.userAgent)&&navigator.maxTouchPoints>1,R=!!(window.webkit&&window.webkit.messageHandlers),O=(()=>{if(k){if(R)return!!/CriOS\/|EdgiOS\/|FxiOS\/|GSA\/|DuckDuckGo\//.test(navigator.userAgent);{const n=document.createElement("a");return!!(n.relList&&n.relList.supports&&n.relList.supports("ar"))}}return!1})(),I=A&&!/firefox|OculusBrowser/i.test(navigator.userAgent);let d="none";O?d="quick-look":I&&(d="scene-viewer");function g(n){return Math.min(window.devicePixelRatio||1,n)}const h=class h{constructor(i,e,t,s){a(this,"id",h.nextId++);a(this,"worker");a(this,"element");a(this,"resizeObserver");a(this,"limitPixelRatio");this.worker=e,this.element=i,this.limitPixelRatio=s;const l=c=>{this.worker.postMessage({type:"event",id:this.id,data:c})};this.worker.postMessage({type:"makeProxy",id:this.id});const o=()=>{const c=this.element.getBoundingClientRect();l({type:"size",left:c.left,top:c.top,width:this.element.clientWidth,height:this.element.clientHeight,pixelRatio:g(this.limitPixelRatio)})};this.resizeObserver=new ResizeObserver(()=>{requestAnimationFrame(o)}),o(),this.resizeObserver.observe(i),this.attachHandlers(t,l)}attachHandlers(i,e){Object.entries(i).forEach(([t,s])=>{this.element.addEventListener(t,l=>{const o=s(l);e(o)})})}disconnect(){this.resizeObserver.disconnect()}};a(h,"nextId",0);let p=h;function r(n){return i=>n(i)}function x(n){return i=>{const e={type:i.type};return n.forEach(t=>{t in i&&(e[t]=i[t])}),e}}const C=n=>{const i=x(["ctrlKey","metaKey","shiftKey","button","pointerType","clientX","clientY","pointerId","pageX","pageY"]),e=t=>({type:t.type,touches:Array.from(t.touches).map(s=>({pageX:s.pageX,pageY:s.pageY,clientX:s.clientX,clientY:s.clientY}))});return{contextmenu:r(t=>(t.preventDefault(),{type:t.type})),click:r(i),mousedown:r(i),mousemove:r(i),mouseup:r(i),mouseleave:r(i),pointerdown:r(i),pointermove:r(i),pointerup:r(i),pointerout:r(i),wheel:r(t=>(n.isInteractive&&t.preventDefault(),{type:t.type,deltaX:t.deltaX,deltaY:t.deltaY})),touchstart:r(e),touchend:r(e),touchmove:r(t=>(n.isInteractive&&t.preventDefault(),e(t))),keydown:r(t=>({type:t.type,key:t.key,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey}))}};class E extends HTMLElement{constructor(){super();a(this,"canvas");a(this,"commonOptions");a(this,"isInteractive",!1);a(this,"limitPixelRatio",/Android/i.test(navigator.userAgent)?2:1/0);a(this,"sceneManager",null);a(this,"worker",null);a(this,"proxy",null);a(this,"useOffscreenCanvas",!1);this.canvas=document.createElement("canvas"),this.useOffscreenCanvas=this.getAttribute("offscreencanvas")==="true";const e=this.isValidURL(this.getAttribute("model")||""),t=this.isValidURL(this.getAttribute("envmap")||""),s=parseFloat(this.getAttribute("target-distance")||"0.8"),l=parseFloat(this.getAttribute("min-distance")||"0.1"),o=parseFloat(this.getAttribute("max-distance")||"1.0"),c=parseFloat(this.getAttribute("init-delay")||"0.0"),u=parseFloat(this.getAttribute("init-delay-interactive")||"0.0"),m={stabilityDuration:parseFloat(this.getAttribute("perf-stability-duration")||"1.0"),measureDuration:parseFloat(this.getAttribute("perf-measure-duration")||"0.5")},f=this.getAttribute("startup")||"auto";this.commonOptions={pixelRatio:g(this.limitPixelRatio),modelUrl:e,envmapUrl:t,minDistance:l,targetDistance:s,maxDistance:o,initDelay:c,initDelayInteractive:u,startup:f,lowPerformanceSettings:this.getLowPerformanceSettings(),perfSampling:m}}addARLink(){if(d==="none")return;const e=d==="quick-look"?"model-usdz":"model-glb",t=this.isValidURL(this.getAttribute(e)||"");if(!t)return;const s=this.getAttribute("model-title")||document.title||"model",o=this.getAttribute("ar-vertical")==="true"?"true":"false",c=document.createElement("a");if(c.textContent="AR",c.classList.add("ar-link"),d==="quick-look")c.setAttribute("rel","ar"),c.setAttribute("href",t);else if(d==="scene-viewer"){const u=window.location.href,m=`intent://arvr.google.com/scene-viewer/1.2?file=${encodeURIComponent(t)}&mode=ar_only&enable_vertical_placement=${o}&title=${encodeURIComponent(s)}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(u)};end;`;c.setAttribute("href",m)}this.appendChild(c)}connectedCallback(){this.appendChild(this.canvas),this.logAttributes(),this.initScene(),this.addARLink()}logAttributes(){console.log("Model URL:",this.commonOptions.modelUrl),console.log("Max distance:",this.commonOptions.maxDistance),console.log("Target distance:",this.commonOptions.targetDistance),console.log("Min distance:",this.commonOptions.minDistance),console.log("Envmap URL:",this.commonOptions.envmapUrl)}isValidURL(e){if(!e)return null;try{return new URL(e,document.baseURI).href}catch{return null}}handleInteractivityChange(e){this.isInteractive=e,e?(this.setAttribute("interactive","true"),this.style.cursor="move"):(this.setAttribute("interactive","false"),this.style.cursor="pointer"),this.dispatchEvent(new CustomEvent("interactivity",{detail:{state:e}}))}handleOnLoaded(e){this.setAttribute("loaded","true"),this.dispatchEvent(new CustomEvent("loaded",{detail:{state:e}}))}handleOnReady(e){this.setAttribute("ready","true"),this.dispatchEvent(new CustomEvent("ready",{detail:{state:e}}))}getLowPerformanceSettings(){const e=navigator.userAgent,t=/(Macintosh|Android)(?!.*KHTML).*Gecko/i.test(e),s=/Android/i.test(e);return t&&this.useOffscreenCanvas?{disableAA:!0,lowResolution:!0}:s||t?{disableAA:!0,lowResolution:!1}:{disableAA:!1,lowResolution:!1}}startWorker(e){const t=e.transferControlToOffscreen(),s=new b;this.worker=s;const l=C(this);this.proxy=new p(e,s,l,this.limitPixelRatio),s.postMessage({type:"start",canvas:t,canvasId:this.proxy.id,...this.commonOptions},[t]),s.onmessage=o=>{switch(o.data.type){case"interactivity":this.handleInteractivityChange(o.data.state);break;case"loaded":this.handleOnLoaded(o.data.state);break;case"ready":this.handleOnReady(o.data.state);break}}}dispose(){this.worker?(this.worker.postMessage({type:"dispose"}),this.worker.terminate(),this.worker=null,this.proxy&&(this.proxy.disconnect(),this.proxy=null)):this.sceneManager&&(this.sceneManager.dispose(),this.sceneManager=null),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas)}disconnectedCallback(){this.dispose()}disposeRenderer(){this.dispose()}attemptInit(){this.worker?this.worker.postMessage({type:"enableRendering"}):this.sceneManager&&this.sceneManager.enableRendering()}abortInit(){this.worker?this.worker.postMessage({type:"disableRendering"}):this.sceneManager&&this.sceneManager.disableRendering()}initScene(){if(this.canvas){if(!(this.commonOptions.modelUrl&&this.commonOptions.envmapUrl)){console.warn("No valid model or envmap found. Scene won't be initialized.");return}this.canvas.transferControlToOffscreen!==void 0&&this.useOffscreenCanvas?this.startWorker(this.canvas):this.sceneManager=w({canvas:this.canvas,inputElement:this.canvas,...this.commonOptions,e_interactivityChange:e=>this.handleInteractivityChange(e),e_loaded:e=>this.handleOnLoaded(e),e_ready:e=>this.handleOnReady(e)})}}}customElements.define("monk-view",E);
